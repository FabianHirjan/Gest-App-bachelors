<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Car List</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <script>
        function deleteCar(id) {
            if (confirm('Are you sure you want to delete this car?')) {
                fetch(`/cars/delete/${id}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete the car.');
                    }
                });
            }
        }

        function addCar() {
            const formData = new FormData(document.getElementById('addCarForm'));
            const data = new URLSearchParams(formData);

            fetch('/createCar', {
                method: 'POST',
                body: data
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to add the car.');
                }
            });
        }

        function assignCar() {
            const carId = document.getElementById('assignCarId').value;
            const employeeId = document.getElementById('assignEmployeeId').value;

            fetch(`/assignCar?carId=${carId}&employeeId=${employeeId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to assign the car.');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/employees')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Employee data fetched:", data); // Log pentru verificarea datelor
                    const employeeSelect = document.getElementById('assignEmployeeId');
                    data.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.text = `${employee.firstName} ${employee.lastName} ${employee.carAssigned ? '(Already assigned)' : ''}`;
                        employeeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Failed to fetch employee data:", error);
                });
        });

    </script>
</head>
<body>
<h1>List of Cars</h1>
<form id="addCarForm" onsubmit="event.preventDefault(); addCar();">
    <label for="make">Make:</label>
    <input type="text" id="make" name="make" required>

    <label for="model">Model:</label>
    <input type="text" id="model" name="model" required>

    <label for="dateOfProduction">Date of Production:</label>
    <input type="date" id="dateOfProduction" name="dateOfProduction" required>

    <label for="mileage">Mileage:</label>
    <input type="number" id="mileage" name="mileage" required>

    <label for="registrationPlate">Registration Plate:</label>
    <input type="text" id="registrationPlate" name="registrationPlate" required>

    <label for="insuranceAvailable">Insurance Available:</label>
    <select id="insuranceAvailable" name="insuranceAvailable" required>
        <option value="true">Yes</option>
        <option value="false">No</option>
    </select>

    <label for="insuranceExpirationDate">Insurance Expiration Date:</label>
    <input type="date" id="insuranceExpirationDate" name="insuranceExpirationDate" required>

    <button type="submit">Add Car</button>
</form>

<form id="assignCarForm" onsubmit="event.preventDefault(); assignCar();">
    <label for="assignCarId">Car ID:</label>
    <input type="number" id="assignCarId" name="carId" required>

    <label for="assignEmployeeId">Employee:</label>
    <select id="assignEmployeeId" name="employeeId" required>
        <!-- Options will be populate by JavaScript -->
    </select>

    <button type="submit">Assign Car</button>
</form>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Mileage</th>
        <th>Make</th>
        <th>Model</th>
        <th>Year of Production</th>
        <th>Registration Plate</th>
        <th>Last Inspection</th>
        <th>Insurance Available</th>
        <th>Insurance Expiration Date</th>
        <th>Driver</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="car : ${cars}">
        <td th:text="${car.id}"></td>
        <td th:text="${car.mileage}"></td>
        <td th:text="${car.make}"></td>
        <td th:text="${car.model}"></td>
        <td th:text="${car.yearOfProduction}"></td>
        <td th:text="${car.registrationPlate}"></td>
        <td th:text="${car.lastInspection}"></td>
        <td th:text="${car.insuranceAvailable ? 'Yes' : 'No'}"></td>
        <td th:text="${car.insuranceExpirationDate}"></td>
        <td th:text="${car.driver != null ? car.driver.firstName + ' ' + car.driver.lastName : 'Unassigned'}"></td>
        <td>
            <button th:onclick="'deleteCar(' + ${car.id} + ')'">Delete</button>
        </td>
    </tr>
    </tbody>
</table>
</body>
</html>
